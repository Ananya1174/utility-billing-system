<h2>Consumer Dashboard</h2>

<div *ngIf="loading">Loading dashboard...</div>

<div *ngIf="!loading && summary">

  <div class="kpi-grid">
    <div class="kpi-card highlight">
      <p>Total Due</p>
      <h3>₹{{ summary.totalOutstanding }}</h3>
    </div>

    <div class="kpi-card">
      <p>Unpaid Bills</p>
      <h3>{{ summary.unpaidBills }}</h3>
    </div>

    <div class="kpi-card">
      <p>Last Payment</p>
      <h3>₹{{ summary.lastPaymentAmount || 0 }}</h3>
    </div>

    <div class="kpi-card">
      <p>Total Bills</p>
      <h3>{{ summary.totalBills }}</h3>
    </div>
  </div>

  <div class="charts-grid">

    <div class="chart-card">
      <div class="chart-header">
        <h3>Consumption by Utility</h3>
        <div class="chart-filters">
          <select [(ngModel)]="month" (change)="onPieFilterChange()">
            <option *ngFor="let m of months" [value]="m.value">{{ m.name }}</option>
          </select>
          <select [(ngModel)]="year" (change)="onPieFilterChange()">
            <option *ngFor="let y of [2024, 2025, 2026]" [value]="y">{{ y }}</option>
          </select>
        </div>
      </div>
      <canvas
        #pieChart
        baseChart
        [type]="pieChartType"
        [data]="pieChartData">
      </canvas>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <h3>Monthly Consumption</h3>
        <div class="chart-filters">
          <select [(ngModel)]="selectedUtility" (change)="onBarFilterChange()">
            <option *ngFor="let u of availableUtilities" [value]="u">{{ u }}</option>
          </select>
          <select [(ngModel)]="year" (change)="onBarFilterChange()">
            <option *ngFor="let y of [2024, 2025, 2026]" [value]="y">{{ y }}</option>
          </select>
        </div>
      </div>
      <canvas
        #barChart
        baseChart
        [type]="barChartType"
        [data]="barChartData">
      </canvas>
    </div>

    <div class="chart-card">
      <h3>Paid vs Unpaid</h3>
      <canvas
        baseChart
        [type]="doughnutChartType"
        [data]="doughnutChartData">
      </canvas>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <h3>Utility Cost Distribution (%)</h3>
        <div class="chart-filters">
          <select [(ngModel)]="utilityCostYear"
                  (change)="onUtilityCostYearChange()">
            <option *ngFor="let y of [2024, 2025, 2026]" [value]="y">
              {{ y }}
            </option>
          </select>
        </div>
      </div>
      <canvas
        #utilityCostChart
        baseChart
        [type]="utilityCostChartType"
        [data]="utilityCostChartData"
        [options]="utilityCostChartOptions">
      </canvas>
    </div>

  </div>

  <div class="actions">
    <button class="primary-btn" (click)="goToBills()">View Bills</button>
    <button class="primary-btn"
            *ngIf="summary.totalOutstanding > 0"
            (click)="payDueBill()">Pay Due</button>
    <button class="secondary-btn" (click)="goToUtilities()">My Utilities</button>
  </div>

</div>