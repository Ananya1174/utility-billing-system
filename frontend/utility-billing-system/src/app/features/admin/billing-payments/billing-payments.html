

<h2>Billing & Payments</h2>
<p class="subtitle">
  View consumer bills, payments, outstanding balance and invoices
</p>

<!-- SEARCH -->
<div class="filters">
  <input
    type="text"
    placeholder="Enter Consumer ID"
    [(ngModel)]="consumerId"
  />
  <button (click)="loadData()">Load</button>
</div>

<p *ngIf="error" class="danger">{{ error }}</p>
<p *ngIf="loading" class="loading">Loading data...</p>

<!-- TABS -->
<div class="tabs">
  <button [class.active]="activeTab==='BILLS'" (click)="switchTab('BILLS')">Bills</button>
  <button [class.active]="activeTab==='PAYMENTS'" (click)="switchTab('PAYMENTS')">Payments</button>
  <button [disabled]="!selectedBill" [class.active]="activeTab==='OUTSTANDING'"
          (click)="activeTab='OUTSTANDING'">Outstanding</button>
  <button [disabled]="!selectedInvoice" [class.active]="activeTab==='INVOICE'"
          (click)="activeTab='INVOICE'">Invoice</button>
</div>

<!-- ================= BILLS ================= -->
<div *ngIf="activeTab==='BILLS'" class="card">
  <table>
    <thead>
      <tr>
        <th class="sortable" (click)="sort('bills','id')">
          Bill ID <span class="sort-icon">{{ sortIcon('bills','id') }}</span>
        </th>
        <th class="sortable" (click)="sort('bills','utilityType')">
          Utility <span class="sort-icon">{{ sortIcon('bills','utilityType') }}</span>
        </th>
        <th>Period</th>
        <th class="sortable" (click)="sort('bills','payableAmount')">
          Amount <span class="sort-icon">{{ sortIcon('bills','payableAmount') }}</span>
        </th>
        <th>Status</th>
        <th></th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let b of pagedBills">
        <td class="mono">{{ b.id }}</td>
        <td>{{ b.utilityType }}</td>
        <td>{{ b.billingMonth }}/{{ b.billingYear }}</td>
        <td>₹ {{ b.payableAmount }}</td>
        <td>{{ b.status }}</td>
        <td>
          <button class="link" (click)="viewBill(b)">View</button>
        </td>
      </tr>
    </tbody>
  </table>

  <p *ngIf="!pagedBills.length" class="empty">No bills available</p>

  <!-- PAGINATION -->
  <div class="pagination">
  <select [(ngModel)]="pageSize" (change)="updatePaging()">
    <option [value]="10">10</option>
    <option [value]="25">25</option>
    <option [value]="50">50</option>
  </select>

  <div class="pager">
    <button class="prev" (click)="prevPage()" [disabled]="pageIndex === 0">
      Prev
    </button>

    <button class="next"
            (click)="nextPage()"
            [disabled]="pageIndex >= totalPages - 1">
      Next
    </button>
  </div>
</div>
</div>

<!-- ================= PAYMENTS ================= -->
<div *ngIf="activeTab==='PAYMENTS'" class="card">
  <table>
    <thead>
      <tr>
        <th class="sortable" (click)="sort('payments','paymentId')">
          Payment ID <span class="sort-icon">{{ sortIcon('payments','paymentId') }}</span>
        </th>
        <th>Bill ID</th>
        <th class="sortable" (click)="sort('payments','amount')">
          Amount <span class="sort-icon">{{ sortIcon('payments','amount') }}</span>
        </th>
        <th>Mode</th>
        <th>Status</th>
        <th>Invoice</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let p of pagedPayments">
        <td class="mono">{{ p.paymentId }}</td>
        <td class="mono">{{ p.billId }}</td>
        <td>₹ {{ p.amount }}</td>
        <td>{{ p.mode }}</td>
        <td>{{ p.status }}</td>
        <td>
          <button *ngIf="p.invoiceId" (click)="viewInvoice(p)">View</button>
          <button *ngIf="p.invoiceId && p.status==='SUCCESS'"
                  (click)="downloadInvoice(p.paymentId)">Download</button>
        </td>
      </tr>
    </tbody>
  </table>

  <p *ngIf="!pagedPayments.length" class="empty">No payments available</p>

  <!-- PAGINATION -->
  <div class="pagination-bar">
    <div class="page-size">
      Show
      <select [(ngModel)]="pageSize" (change)="changePageSize()">
        <option [value]="10">10</option>
        <option [value]="25">25</option>
        <option [value]="50">50</option>
      </select>
      entries
    </div>

    <div class="pager">
      <button (click)="prevPage()" [disabled]="pageIndex===0">Prev</button>
      <span>Page {{ pageIndex + 1 }} of {{ totalPages }}</span>
      <button (click)="nextPage()" [disabled]="pageIndex>=totalPages-1">Next</button>
    </div>
  </div>
</div>