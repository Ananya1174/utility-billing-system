<h2>Billing & Payments</h2>
<p class="subtitle">
  View consumer bills, payments, outstanding balance and invoices
</p>

<!-- SEARCH -->
<div class="search-box">
  <input
    type="text"
    placeholder="Enter Consumer ID"
    [(ngModel)]="consumerId"
  />
  <button (click)="loadData()">Load</button>
</div>

<p *ngIf="error" class="error">{{ error }}</p>
<p *ngIf="loading" class="loading">Loading data...</p>

<!-- TABS -->
<div class="tabs">
  <button [class.active]="activeTab==='BILLS'" (click)="activeTab='BILLS'">Bills</button>
  <button [class.active]="activeTab==='PAYMENTS'" (click)="activeTab='PAYMENTS'">Payments</button>
  <button [disabled]="!selectedBill" [class.active]="activeTab==='OUTSTANDING'" (click)="activeTab='OUTSTANDING'">
    Outstanding
  </button>
  <button [disabled]="!selectedInvoice" [class.active]="activeTab==='INVOICE'" (click)="activeTab='INVOICE'">
    Invoice
  </button>
</div>

<!-- ================= BILLS ================= -->
<div *ngIf="activeTab==='BILLS'" class="card">
  <table>
    <tr>
      <th>Bill ID</th>
      <th>Utility</th>
      <th>Period</th>
      <th>Amount</th>
      <th>Status</th>
      <th></th>
    </tr>

    <tr *ngFor="let b of bills">
      <td class="mono">{{ b.id }}</td>
      <td>{{ b.utilityType }}</td>
      <td>{{ b.billingMonth }}/{{ b.billingYear }}</td>
      <td>â‚¹ {{ b.payableAmount }}</td>
      <td>
        <span class="status" [ngClass]="b.status.toLowerCase()">
          {{ b.status }}
        </span>
      </td>
      <td>
        <button class="link" (click)="viewBill(b)">View</button>
      </td>
    </tr>
  </table>

  <p *ngIf="!bills.length" class="empty">No bills available</p>
</div>

<!-- ================= PAYMENTS ================= -->
<div *ngIf="activeTab==='PAYMENTS'" class="card">
  <table>
    <tr>
      <th>Payment ID</th>
      <th>Bill ID</th>
      <th>Amount</th>
      <th>Mode</th>
      <th>Status</th>
      <th>Invoice</th>
    </tr>

    <tr *ngFor="let p of payments">
      <td class="mono">{{ p.paymentId }}</td>
      <td class="mono">{{ p.billId }}</td>
      <td>â‚¹ {{ p.amount }}</td>
      <td>{{ p.mode }}</td>
      <td>{{ p.status }}</td>
      <td>
       <button
  *ngIf="p.invoiceId"
  (click)="viewInvoice(p)">
  View Invoice
</button>
        <button
  *ngIf="p.status === 'SUCCESS' && p.invoiceId"
  (click)="downloadInvoice(p.paymentId)">
  Download
</button>
      </td>
    </tr>
  </table>

  <p *ngIf="!payments.length" class="empty">No payments available</p>
</div>

<!-- ================= OUTSTANDING ================= -->
<div *ngIf="activeTab==='OUTSTANDING' && outstanding" class="summary-card">
  <h3>Outstanding Summary</h3>

  <div class="row">
    <span>Total Amount</span>
    <span>â‚¹ {{ outstanding.totalAmount }}</span>
  </div>

  <div class="row">
    <span>Paid</span>
    <span>â‚¹ {{ outstanding.totalPaid }}</span>
  </div>

  <div class="row highlight">
    <span>Outstanding</span>
    <span>â‚¹ {{ outstanding.outstandingAmount }}</span>
  </div>
</div>

<!-- INVOICE -->
<div *ngIf="activeTab === 'INVOICE' && selectedInvoice" class="invoice">

  <h3>ðŸ§¾ Invoice Details</h3>

  <div class="invoice-grid">
    <div><b>Invoice Number:</b> {{ selectedInvoice.invoiceNumber }}</div>
    <div><b>Invoice Date:</b> {{ selectedInvoice.invoiceDate | date }}</div>

    <div><b>Billing Period:</b>
      {{ selectedInvoice.billingMonth }}/{{ selectedInvoice.billingYear }}
    </div>

    <div><b>Consumer ID:</b> {{ selectedInvoice.consumerId }}</div>
    <div><b>Bill ID:</b> {{ selectedInvoice.billId }}</div>
    <div><b>Payment ID:</b> {{ selectedInvoice.paymentId }}</div>
  </div>

  <hr />

  <h4>ðŸ’° Charges</h4>

  <table class="invoice-table">
    <tr>
      <td>Energy Charge</td>
      <td>â‚¹ {{ selectedInvoice.energyCharge }}</td>
    </tr>
    <tr>
      <td>Tax</td>
      <td>â‚¹ {{ selectedInvoice.tax }}</td>
    </tr>
    <tr>
      <td>Penalty</td>
      <td>â‚¹ {{ selectedInvoice.penalty }}</td>
    </tr>
    <tr class="total">
      <td>Total Amount</td>
      <td>â‚¹ {{ selectedInvoice.totalAmount }}</td>
    </tr>
    <tr>
      <td>Amount Paid</td>
      <td>â‚¹ {{ selectedInvoice.amountPaid }}</td>
    </tr>
  </table>

</div>